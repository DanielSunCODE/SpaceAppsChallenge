<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEMPO AIR ‚Äì Panel</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Heatmap plugin (opcional) -->
  <!-- <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script> -->

  <style>
    :root{
      --bg:#0b1220;--text:#e9f0ff;--muted:#93a4c2;--card:#0e1525;
      --good:#2ecc71;--regular:#f1c40f;--bad:#e74c3c;--brand:#6fb1ff;
    }
    *{box-sizing:border-box; scroll-margin: 4rem;}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    html{scroll-behavior:smooth;}

    header{
      position:fixed;top:0;left:0;right:0;height:64px;z-index:20;
      display:flex;align-items:center;justify-content:space-between;
      padding:0 24px;background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.00));
      backdrop-filter:blur(6px);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:0 20px; width:100%}
    .row{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .logo{font-weight:800; letter-spacing:.5px}
    nav{z-index: 999;display:flex; gap:10px; align-items:center}
    .nav-btn{font-weight:700; font-size:14px; padding:8px 12px; border-radius:12px; text-decoration:none; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06)}
    .nav-btn:hover{border-color:rgba(255,255,255,.35)}
    .icon-btn{display:inline-flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06)}

    /* Banner */
    .banner {
      position: relative;
      height: 100vh;
      width: 100%;
      overflow: hidden;
      text-align: center;
    }
    .banner img {position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;}
    .banner .overlay {position: absolute; inset: 0; background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(11,18,32,1) 90%);}
    .title {position: absolute; bottom: 36%; left: 50%; transform: translateX(-50%); width: min(1200px, 92vw); padding: 0 20px; color: var(--text);}
    .title h1{margin:0;font-size:clamp(28px,4.5vw,48px)}
    .title p{margin:10px 0 16px;color:var(--muted)}
    .explore-btn{display:inline-block;background:#d9d9d9;color:#000;font-weight:600;font-size:16px;
      padding:12px 32px;margin-top: 12px;border-radius:999px;text-decoration:none;transition:all 0.3s ease;}
    .explore-btn:hover{background:#fff;transform:translateY(-3px)}

    .hour-strip{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border-top:1px solid rgba(255,255,255,.08);border-bottom:1px solid rgba(255,255,255,.08);}
    .hour-content{max-width:1200px;margin:0 auto;padding:14px 20px;display:grid;grid-template-columns:150px 1fr;gap:16px;align-items:center}
    .hour-label{font-weight:800;color:#cfe3ff}
    .chips{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
    .chip{display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:#0e1525;white-space:nowrap;font-weight:700;font-size:12px;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE y Edge antiguos */}
    .chip .bi{font-size:14px}
    .chips::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Edge (moderno) */
    }

    .section{max-width:1200px; margin:18px auto; padding:0 20px}
    .grid{display:grid; grid-template-columns: 1fr 3fr; gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px}
    .card h3{margin:0 0 10px; font-size:16px; color:#cfe3ff}

    .forecast-list{display:grid; gap:10px; overflow: hidden !important}
    .day{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px; background:#0e1525; border:1px solid rgba(255,255,255,.06)}
    .day strong{letter-spacing:.2px}
    .tag{font-size:12px; font-weight:800; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.16)}

    #map{height: calc(80vh - 60px); border-radius:12px; z-index: 10;}

    .alerts{max-width:1200px; margin:18px auto; padding:0 20px}
    .alert-panel{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px}
    .alert-panel p{margin:8px 0; color:#cfe3ff}

    .center{display:flex; justify-content:center;}
    .btn-primary{display:inline-flex; align-items:center; gap:8px; padding:12px 18px; border-radius:14px; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg, rgba(111,177,255,.35), rgba(111,177,255,.15)); font-weight:800; text-decoration:none; color:var(--text)}
    .btn-primary:hover{background:linear-gradient(180deg, rgba(111,177,255,.45), rgba(111,177,255,.25));}

    .modal{z-index: 9999 !important; position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center;}
    .modal .box{background:#0e1525; border:1px solid rgba(255,255,255,.12); border-radius:16px; width:min(464px,92vw); padding:16px; animation:fadeIn .3s;overflow-y: auto;max-height: 80vh;}
    .leaflet-pane,.leaflet-top,.leaflet-bottom {z-index:100 !important;}
    .modal .closeBtn i {color: #ffffff !important; font-size: 20px; pointer-events: none;}
    .modal .closeBtn:hover i {color: var(--brand);}
    .modal h3{margin:0 0 12px}
    .input{width:100%;margin-top:8px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0b1220;color:var(--text);}
    .input:focus{outline:none;border-color:var(--brand);}
    .msg{margin-top:6px;font-size:13px;min-height:18px;}

    /* Air Summary */
    .air-summary {display:flex;justify-content:center;align-items:center;background:transparent;padding:20px;text-align:center;}
    .air-box {background:none;border:none;border-radius:16px;padding:0 20px 30px;max-width:340px;width:100%;}
    .air-box .location {color: var(--muted); font-size: 14px; margin-bottom: 8px;}
    .air-box .status {font-size:36px;font-weight:800;margin:0;color:var(--regular);letter-spacing:1px;}
    .air-box .aqi-text {color:var(--muted);font-size:14px;margin-top:4px;margin-bottom:16px;}
    .aqi-bar {position: relative;height:10px;border-radius:6px;overflow:hidden;}
    .gradient-bar {width:100%;height:100%;background:linear-gradient(to right, var(--bad), var(--regular), var(--good));border-radius:6px;}
    .indicator {position:absolute;top:-2px;width:14px;height:13px;border-radius:50%;background:#fff;border:2px solid var(--bg);transform:translateX(-50%);}

    @keyframes fadeIn{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}

    @media (max-width:980px){
      .hour-content{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      #map{height: calc(60vh - 60px);}
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header>
    <div class="wrap">
      <div class="row">
        <div class="logo">TEMPO AIR</div>
        <nav>
          <a class="nav-btn" href="#explorar">Explore Map</a>
          <a class="nav-btn" href="#" id="btnLogin">Log In</a>
          <a class="nav-btn" href="#" id="btnSignin">Sign In</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Banner -->
  <section class="banner">
    <img src="./Media/BannerImg.png" alt="Banner">
    <div class="overlay"></div>
    <div class="title">
      <h1>TEMPO AIR</h1>
      <p>Monitor air quality with NASA TEMPO satellite data and receive personalized health alerts to protect you and your family.</p>
      <a href="#explorar" class="explore-btn">Explore Map</a>
    </div>
  </section>

  <!-- Air Quality Summary -->
  <section class="air-summary">
    <div class="air-box">
      <p class="location"><i class="bi bi-geo-alt-fill"></i> Saltillo, Coahuila</p>
      <h2 class="status" id="aqiStatus">REGULAR</h2>
      <p class="aqi-text">Air Quality <span id="aqiValue">37</span></p>
      <div class="aqi-bar">
        <div class="gradient-bar"></div>
        <div class="indicator" id="aqiIndicator" style="left: 67%;"></div>
      </div>
    </div>
  </section>

  <!-- Hour Forecast -->
  <section class="hour-strip">
    <div class="hour-content">
      <div class="hour-label">HOUR PER HOUR FORECAST</div>
      <div class="chips" id="hourChips"></div>
    </div>
  </section>

  <!-- Predicci√≥n y Mapa -->
  <section class="section" id="explorar">
    <div class="grid">
      <div class="card">
        <h3>10-DAY FORECAST</h3>
        <div class="forecast-list" id="forecast"></div>
      </div>
      <div class="card">
        <h3>Pollution Map</h3>
        <div id="map"></div>
      </div>
    </div>
  </section>

  <!-- Alertas -->
  <section class="alerts">
    <div class="alert-panel">
      <h3>ALERTAS</h3>
      <!-- Todo el contenido ser√° din√°mico aqu√≠ -->
      <div id="alerts"></div>
    </div>
  </section>

  <!-- Bot√≥n Power BI -->
  <section class="section center">
    <a class="btn-primary" id="btnPowerBI" href="https://air-insight-nexus.lovable.app" target="_blank" rel="noopener">
      <i class="bi bi-graph-up"></i> Statistics
    </a>
  </section>

  <!-- Script principal -->
  <script>
  // ===== Estado =====
  let rows = [];
  let map, heat, markers = [];
  const usersDB = [{ email: "test@gmail.com", password: "1234", name: "test" }];

  // ===== Utilidades =====
  function classifyScore(score){
    if(score < 41) return {label:'Bad', color:'var(--bad)', icon:'bi-exclamation-triangle-fill'};
    if(score > 60) return {label:'Good', color:'var(--good)', icon:'bi-heart-fill'};
    return {label:'Regular', color:'var(--regular)', icon:'bi-shield-check'};
  }
  function fmt(n,d=2){return (n==null||isNaN(n))?'‚Äî':Number(n).toFixed(d)}
  function scoreFrom(r){
    const z = ((r.no2/100)*25 + (Math.max(0,r.o3)/120)*20 + (r.hcho/0.002)*15 + (r.so2/0.002)*15 + (r.co/2.0)*25)*100;
    return Math.max(0, Math.min(100, z));
  }
  function normalizeRow(row){
    const time = new Date(row.datetime || row.date_time || row.fecha || row.time);
    const lat = parseFloat(row.latitude ?? row.lat);
    const lon = parseFloat(row.longitude ?? row.lon ?? row.lng);
    const no2 = parseFloat(row.no2_value ?? row.no2);
    const o3  = parseFloat(row.o3_value ?? row.o3);
    const hcho= parseFloat(row.hcho_value ?? row.hcho);
    const so2 = parseFloat(row.so2_value ?? row.so2);
    const co  = parseFloat(row.co_value ?? row.co);
    return {time, lat, lon, no2, o3, hcho, so2, co};
  }

  // === Alertas din√°micas desde <span id="aqiValue">
  function actualizarAlertasDesdeAQI() {
    const aqiValueEl = document.getElementById("aqiValue");
    const statusEl   = document.getElementById("aqiStatus");
    const indicatorEl= document.getElementById("aqiIndicator");
    const alertBox   = document.querySelector(".alert-panel");
    const alertContainer = document.getElementById("alerts");
    if (!aqiValueEl || !statusEl || !indicatorEl || !alertBox || !alertContainer) return;

    const raw = parseFloat(aqiValueEl.textContent.trim());
    const aqi = isNaN(raw) ? 0 : Math.max(0, Math.min(100, raw));

    let message = "", description = "", bgColor = "", color = "", icon = "";
    if (aqi < 41) {
      message = "Poor air quality";
      description = "‚ö†Ô∏è Pollution levels are high. It‚Äôs recommended to stay indoors.";
      bgColor = "linear-gradient(180deg, rgba(231,76,60,.15), rgba(231,76,60,.05))";
      color = "var(--bad)"; icon = "bi-emoji-frown"; statusEl.textContent = "POOR";

      // === Mostrar alerta personalizada si hay usuario logeado
      if (window.currentUser && !window.healthAlertShown) {
        window.healthAlertShown = true; // evita repetirla
        showHealthAlert(window.currentUser, aqi);
      }

    } else if (aqi <= 60) {
      message = "Moderate air quality";
      description = "There are some pollutants present. Avoid intense outdoor activities.";
      bgColor = "linear-gradient(180deg, rgba(241,196,15,.15), rgba(241,196,15,.05))";
      color = "var(--regular)"; icon = "bi-emoji-neutral"; statusEl.textContent = "MODERATE";
    } else {
      message = "Good air quality";
      description = "Breathe easy üåø, pollution levels are within a healthy range.";
      bgColor = "linear-gradient(180deg, rgba(46,204,113,.15), rgba(46,204,113,.05))";
      color = "var(--good)"; icon = "bi-emoji-smile"; statusEl.textContent = "GOOD";
    }

    statusEl.style.color = color;
    alertBox.style.background = bgColor;
    indicatorEl.style.left = aqi + "%";
    alertContainer.innerHTML = `
      <h3 style="display:flex;align-items:center;gap:8px;">
        <i class="bi ${icon}" style="font-size:20px;color:${color};"></i> ${message}
      </h3>
      <p style="color:#cfe3ff;">${description}</p>
      <p style="font-size:13px;color:var(--muted)">Current AQI index: ${aqi}</p>
    `;
  }


  const observer = new MutationObserver(actualizarAlertasDesdeAQI);
  window.addEventListener("DOMContentLoaded", () => {
    const aqiNode = document.getElementById("aqiValue");
    if (aqiNode) observer.observe(aqiNode, { childList: true, characterData: true, subtree: true });
    actualizarAlertasDesdeAQI();
  });

// === Modal de alerta personalizada
  function showHealthAlert(user, aqi) {
    // evita mostrarlo varias veces
    if (document.querySelector('#healthAlertModal')) return;

    const advice = {
      "Asthma": "wheezing, chest tightness or shortness of breath.",
      "Chronic Bronchitis": "increased coughing and mucus production.",
      "COPD": "reduced breathing capacity and chest discomfort.",
      "Allergies": "runny nose, itchy eyes and sneezing.",
      "Heart Disease": "increased risk of palpitations and fatigue.",
      "Sinusitis": "sinus pressure and headache."
    };

    const userConditions = user.conditions?.filter(c => c !== "None") || [];
    let risksHTML = userConditions.length
      ? userConditions.map(c => `<li>${advice[c] || "general respiratory irritation."}</li>`).join('')
      : `<li>general discomfort due to pollution.</li>`;

    const modal = document.createElement('div');
    modal.id = 'healthAlertModal';
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="box" style="border:2px solid var(--bad);background:#0b1220;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3><i class="bi bi-exclamation-octagon" style="color:var(--bad);"></i> Health Alert</h3>
          <button class="icon-btn closeBtn"><i class="bi bi-x"></i></button>
        </div>
        <p style="color:#ffcccc;">
          ‚ö†Ô∏è Cuidado ${user.name}, the air quality in your area is <b>poor</b> (AQI ${aqi}).
        </p>
        <p style="color:var(--muted);">We recommend avoiding outdoor activities. You may experience:</p>
        <ul style="color:#cfe3ff; margin-left:20px;">${risksHTML}</ul>
      </div>
    `;
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    modal.querySelector('.closeBtn').onclick = () => { modal.remove(); document.body.style.overflow='auto'; };
    modal.onclick = e => { if(e.target===modal){ modal.remove(); document.body.style.overflow='auto'; } };
  }

  // === Pron√≥stico (demo)
  function renderHourStrip(predicciones = []){
    const cont = document.getElementById('hourChips');
    cont.innerHTML = '';
    const now = new Date();
    for(let i=0; i<10; i++){
      const hour = new Date(now.getTime() + i*60*60*1000);
      const label = i===0 ? 'Now' : `${hour.getHours().toString().padStart(2,'0')}:00`;
      const score = predicciones[i] ?? Math.floor(40 + Math.random()*60);
      const {label:state, color, icon} = classifyScore(score);
      const div = document.createElement('div');
      div.className = 'chip';
      div.style.borderColor = `color-mix(in srgb, ${color} 40%, transparent)`;
      div.innerHTML = `<i class="bi ${icon}"></i> ${label} ¬∑ ${state} (${score})`;
      cont.appendChild(div);
    }
  }
  function renderForecast(predicciones = []){
    const box = document.getElementById('forecast');
    box.innerHTML = '';
    const days = ['Today','Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    for(let i=0;i<days.length;i++){
      const score = predicciones[i] ?? Math.floor(40 + Math.random()*60);
      const c = classifyScore(score);
      const div = document.createElement('div');
      div.className = 'day';
      div.innerHTML = `<strong>${days[i]}</strong><span class="tag" style="border-color:${c.color}">${c.label} ¬∑ ${score}</span>`;
      box.appendChild(div);
    }
  }

  // === Mapa ===
  function initMap(){
    map = L.map('map').setView([25.438, -100.99], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  }

  async function loadAirJson() {
    try {
      const res = await fetch('public/data/air_quality_data.json', { cache: 'no-cache' });
      const data = await res.json();
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      data.forEach(zone => {
        const aqi = Number(zone.AQI_Global ?? 0);
        let color = 'gray';
        if (aqi >= 90) color = '#00c853';
        else if (aqi >=75) color = '#4caf50';
        else if (aqi >=60) color = '#ffb300';
        else if (aqi >=40) color = '#ff7043';
        else color = '#e53935';

        const marker = L.circleMarker([zone.latitude, zone.longitude], {
          color, fillColor: color, fillOpacity: 0.6, radius: 10, weight: 2
        }).addTo(map);

        const html = `
          <b>${zone.zone ?? 'Zone'}</b><br>
          ${zone.datetime ? new Date(zone.datetime).toLocaleString() : ''}<br><br>
          <b>Quality:</b> ${zone.Calidad_Aire ?? ''} (${aqi.toFixed(1)}%)<br>
          NO‚ÇÇ: ${zone.no2_value}<br>
          O‚ÇÉ:  ${zone.o3_value}<br>
          HCHO:${zone.hcho_value}<br>
          SO‚ÇÇ: ${zone.so2_value}<br>
          CO:  ${zone.co_value}<br>
        `;
        marker.bindPopup(html);
        markers.push(marker);
      });
    } catch (err) {
      console.error('Error loading air_quality_data.json:', err);
    }
  }

  async function loadCSVFromInput(file){
    return new Promise((resolve,reject)=>{
      Papa.parse(file,{header:true,dynamicTyping:true,skipEmptyLines:true,complete:res=>resolve(res.data),error:reject});
    });
  }
  function ingest(data){
    rows = data.map(normalizeRow).filter(r=>r.time && !Number.isNaN(r.co)).sort((a,b)=>a.time-b.time);
    if(!rows.length){alert('CSV without valid rows');return;}
    renderHourStrip();renderForecast();renderPollution();
  }
  function renderPollution(){
    markers.forEach(m=>map.removeLayer(m)); markers=[];
    if(heat){map.removeLayer(heat);heat=null;}
    const pts = rows.slice(-200).filter(r=>r.lat&&r.lon).map(r=>({lat:r.lat, lon:r.lon, s:scoreFrom(r)}));
    if(window.L && L.heatLayer && pts.length){
      const heatData = pts.map(p=>[p.lat,p.lon,Math.max(0.2,p.s/100)]);
      heat = L.heatLayer(heatData,{radius:22,blur:18,maxZoom:12,minOpacity:.3}).addTo(map);
    }
  }

  // === MODALES LOGIN / SIGNUP ===
  function createModal(title, contentHTML){
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="box">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h3><i class="bi bi-person-circle"></i> ${title}</h3>
          <button class="icon-btn closeBtn"><i class="bi bi-x"></i></button>
        </div>
        <div class="content">${contentHTML}</div>
      </div>`;
    document.body.appendChild(modal);
    modal.querySelector('.closeBtn').onclick = ()=>{ modal.style.display='none'; document.body.style.overflow='auto'; };
    modal.onclick = e=>{if(e.target===modal){modal.style.display='none';document.body.style.overflow='auto';}};
    return modal;
  }

  // === Login / Signup contenido ===
  const loginModal = createModal('Login', `
    <p style="color:var(--muted)">Enter your email and password to access.</p>
    <input id="loginEmail" type="email" placeholder="Email" class="input" />
    <input id="loginPass" type="password" placeholder="Password" class="input" />
    <button class="btn-primary" style="margin-top:8px" id="doLogin"><i class="bi bi-box-arrow-in-right"></i> Sign In</button>
    <p id="loginMsg" class="msg"></p>
    <p style="margin-top:8px;font-size:13px;">Don't have an account? <a href="#" id="goSignup">Sign Up</a></p>
  `);

  const signupModal = createModal('Sign In', `
    <p style="color:var(--muted)">Create a new account to personalize your alerts.</p>
    <input id="signupName" type="text" placeholder="Name" class="input" />
    <input id="signupEmail" type="email" placeholder="Email" class="input" />
    <input id="signupPass" type="password" placeholder="Password" class="input" />

    <div style="position: relative; margin-top: 8px;">
      <input id="signupCity" type="text" placeholder="Your City" class="input" autocomplete="off" />
      <div id="citySuggestions" style="position:absolute;top:100%;left:0;right:0;background:#0e1525;border:1px solid rgba(255,255,255,.1);border-radius:8px;max-height:150px;overflow-y:auto;display:none;z-index:999;"></div>
    </div>

    <p style="margin-top:14px;color:var(--muted)">Select your health conditions:</p>
    <div id="healthConditions" style="display:grid;gap:6px;text-align:left;margin-top:6px;">
      <label><input type="checkbox" value="Asthma"> Asthma</label>
      <label><input type="checkbox" value="Chronic Bronchitis"> Chronic Bronchitis</label>
      <label><input type="checkbox" value="COPD"> COPD</label>
      <label><input type="checkbox" value="Allergies"> Respiratory Allergies</label>
      <label><input type="checkbox" value="Heart Disease"> Heart Disease</label>
      <label><input type="checkbox" value="Sinusitis"> Sinusitis</label>
      <label><input type="checkbox" value="None"> None</label>
    </div>

    <button class="btn-primary" style="margin-top:12px" id="doSignup"><i class="bi bi-person-plus"></i> Sign Up</button>
    <p id="signupMsg" class="msg"></p>
    <p style="margin-top:8px;font-size:13px;">Already have an account? <a href="#" id="goLogin">Log In</a></p>
  `);

  // === L√≥gica ===
  const cityList = ["Saltillo","Monterrey","Guadalajara","Mexico City","Tijuana","Puebla","Cancun","M√©rida","Quer√©taro","Le√≥n","Chihuahua","Veracruz","Torre√≥n","Durango","Hermosillo"];
  const cityInput = signupModal.querySelector('#signupCity');
  const cityBox = signupModal.querySelector('#citySuggestions');
  cityInput.addEventListener('input', () => {
    const val = cityInput.value.toLowerCase().trim();
    cityBox.innerHTML = '';
    if (!val) { cityBox.style.display = 'none'; return; }
    const matches = cityList.filter(c => c.toLowerCase().includes(val));
    matches.forEach(city => {
      const item = document.createElement('div');
      item.textContent = city;
      item.style.padding = '6px 10px';
      item.style.cursor = 'pointer';
      item.onclick = () => { cityInput.value = city; cityBox.style.display = 'none'; };
      cityBox.appendChild(item);
    });
    cityBox.style.display = matches.length ? 'block' : 'none';
  });

  // none desactiva el resto
  signupModal.querySelectorAll('#healthConditions input[value="None"]')[0].addEventListener('change', (e)=>{
    if(e.target.checked){
      signupModal.querySelectorAll('#healthConditions input:not([value="None"])').forEach(ch=>ch.checked=false);
    }
  });
  signupModal.querySelectorAll('#healthConditions input:not([value="None"])').forEach(ch=>{
    ch.addEventListener('change', ()=>{
      if(ch.checked)
        signupModal.querySelector('#healthConditions input[value="None"]').checked=false;
    });
  });

  // Botones
  document.getElementById('btnLogin').onclick = ()=>{ loginModal.style.display='flex';document.body.style.overflow='hidden'; };
  document.getElementById('btnSignin').onclick = ()=>{ signupModal.style.display='flex';document.body.style.overflow='hidden'; };
  loginModal.querySelector('#goSignup').onclick = ()=>{ loginModal.style.display='none'; signupModal.style.display='flex';document.body.style.overflow='hidden'; };
  signupModal.querySelector('#goLogin').onclick = ()=>{ signupModal.style.display='none'; loginModal.style.display='flex';document.body.style.overflow='hidden'; };

  // === LOGIN ===
loginModal.querySelector('#doLogin').onclick = () => {
  const email = loginModal.querySelector('#loginEmail').value.trim();
  const pass = loginModal.querySelector('#loginPass').value.trim();
  const msg = loginModal.querySelector('#loginMsg');

  // Buscar usuario (no validamos duplicados)
  const user = usersDB.find(u => u.email === email && u.password === pass);
  if (user) {
    msg.textContent = `Welcome, ${user.name}!`;
    msg.style.color = 'var(--good)';
    window.currentUser = user;
    window.healthAlertShown = false; // reset para mostrar alertas nuevas
    setTimeout(() => {
      loginModal.style.display = 'none';
      document.body.style.overflow = 'auto';
      verificarAQIInicial(); // üëà al iniciar sesi√≥n, revisar si el aire es malo
    }, 1000);
  } else {
    msg.textContent = "User not found. Redirecting to sign up...";
    msg.style.color = 'var(--bad)';
    setTimeout(() => {
      loginModal.style.display = 'none';
      signupModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }, 1000);
  }
};

// === SIGNUP ===
signupModal.querySelector('#doSignup').onclick = () => {
  const name = signupModal.querySelector('#signupName').value.trim();
  const email = signupModal.querySelector('#signupEmail').value.trim();
  const pass = signupModal.querySelector('#signupPass').value.trim();
  const city = signupModal.querySelector('#signupCity').value.trim();
  const msg = signupModal.querySelector('#signupMsg');
  const selectedConditions = Array.from(
    signupModal.querySelectorAll('#healthConditions input:checked')
  ).map(ch => ch.value);

  if (!name || !email || !pass || !city) {
    msg.textContent = "Complete all fields.";
    msg.style.color = 'var(--bad)';
    return;
  }
  if (!cityList.some(c => c.toLowerCase() === city.toLowerCase())) {
    msg.textContent = "Invalid city.";
    msg.style.color = 'var(--bad)';
    return;
  }

  const newUser = { name, email, password: pass, city, conditions: selectedConditions };
  usersDB.push(newUser);
  msg.textContent = "Account created successfully!";
  msg.style.color = 'var(--good)';
  setTimeout(() => {
    signupModal.style.display = 'none';
    loginModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }, 1000);
};

// === FUNCI√ìN PARA MOSTRAR ALERTA SI EL AIRE ES MALO AL CARGAR ===
function verificarAQIInicial() {
  const aqiEl = document.getElementById("aqiValue");
  const aqi = parseFloat(aqiEl?.textContent.trim()) || 0;
  if (aqi < 41 && window.currentUser && !window.healthAlertShown) {
    window.healthAlertShown = true;
    setTimeout(() => {
      showHealthAlert(window.currentUser, aqi);
    }, 1500); // peque√±o delay para no interrumpir la carga inicial
  }
}

// === LLAMAR TAMBI√âN AL CARGAR LA P√ÅGINA SI YA HAY USUARIO ACTIVO ===
window.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    verificarAQIInicial();
  }, 1500);
});

  // ===== Drag & Drop CSV (opcional) =====
  document.addEventListener('dragover', e=>e.preventDefault());
  document.addEventListener('drop', async e=>{
    e.preventDefault();
    const file = e.dataTransfer.files?.[0];
    if(!file)return;
    const data = await loadCSVFromInput(file);
    ingest(data);
  });

  // ===== Boot =====
  window.addEventListener('DOMContentLoaded', async ()=>{
    initMap();
    renderHourStrip();
    renderForecast();

    // Demo CSV temporal
    const sample = `datetime,latitude,longitude,no2,o3,hcho,so2,co
2025-10-04 06:00:00+00:00,25.43932,-100.98761,48.70,-37.15,0.000248,0.000156,0.013653
2025-10-04 06:15:00+00:00,25.43695,-100.99498,44.15,-37.66,0.000112,0.000190,0.032190
2025-10-04 06:30:00+00:00,25.44460,-100.98054,44.04,-29.05,0.000010,0.000197,0.025429`;
    Papa.parse(sample,{header:true,dynamicTyping:true,complete:r=>ingest(r.data)});

    // Cargar marcadores del JSON
    loadAirJson();
  });
  /* ====== ALERTA AUTOM√ÅTICA SI AQI ES MALO ====== */

// Funci√≥n para crear el modal de alerta visual
function showHealthAlert(aqi) {
  // Evita que se muestre m√°s de una vez
  if (window.healthAlertShown) return;
  window.healthAlertShown = true;

  const modal = document.createElement("div");
  modal.id = "healthAlertModal";
  modal.className = "modal";
  modal.innerHTML = `
    <div class="box" style="border:2px solid var(--bad);background:#0b1220;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="color:var(--bad)">
          <i class="bi bi-exclamation-octagon"></i> Health Alert
        </h3>
        <button class="icon-btn closeBtn"><i class="bi bi-x"></i></button>
      </div>
      <p style="color:#ffcccc;margin-top:10px">
        ‚ö†Ô∏è TestUser, Air quality is currently <b>poor</b> (AQI ${aqi}). 
        It‚Äôs recommended to stay indoors and limit outdoor activity.
      </p>
      <p style="color:#ffcccc;margin-top:10px">
        You that have asthma can present the next syntoms:
      </p>
      <ul style="color:#ffcccc">
        <li>Tos persistente o m√°s frecuente de lo normal</li>
        <li>Dificultad para respirar (disnea leve)</li>
        <li>Sensaci√≥n de opresi√≥n en el pecho</li>
        <li>Irritaci√≥n en garganta o nariz</li>
        <li>Cansancio o debilidad general al realizar actividades f√≠sicas</li>
      <ul>
    </div>
  `;
  document.body.appendChild(modal);
  modal.style.display = "flex";
  document.body.style.overflow = "hidden";
  modal.querySelector(".closeBtn").onclick = () => {
    modal.remove();
    document.body.style.overflow = "auto";
  };
  modal.onclick = (e) => {
    if (e.target === modal) {
      modal.remove();
      document.body.style.overflow = "auto";
    }
  };
}

// Revisa el valor de AQI actual y muestra alerta si es bajo
function verificarAQIInicial() {
  const aqiEl = document.getElementById("aqiValue");
  if (!aqiEl) return;
  const aqi = parseFloat(aqiEl.textContent.trim()) || 0;
  console.log("AQI detectado:", aqi);
  if (aqi < 41) {
    setTimeout(() => {
      showHealthAlert(aqi);
    }, 1500); // delay de 1.5 s para no interrumpir la carga
  }
}

// Ejecutar la verificaci√≥n al cargar completamente la p√°gina
window.addEventListener("DOMContentLoaded", () => {
  verificarAQIInicial();
});
</script>


</body>
</html>
