<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TEMPO AIR – Panel (Figma Match)</title>
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Heatmap plugin (opcional) -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <style>
    :root{
      --bg:#0b1220; --text:#e9f0ff; --muted:#93a4c2; --card:#0e1525;
      --good:#2ecc71; --regular:#f1c40f; --bad:#e74c3c; --brand:#6fb1ff;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text)}
    a{color:inherit}

    /* Header transparente sobre banner */
    header{
      position:fixed; inset:0 auto auto 0; height:64px; z-index:20;
      display:flex; align-items:center; width:100%;
      background:linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,.00));
      backdrop-filter: blur(6px);
    }
    .wrap{max-width:1200px; margin:0 auto; padding:0 20px; width:100%}
    .row{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .logo{font-weight:800; letter-spacing:.5px}
    nav{display:flex; gap:10px; align-items:center}
    .nav-btn{font-weight:700; font-size:14px; padding:8px 12px; border-radius:12px; text-decoration:none; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06)}
    .nav-btn:hover{border-color:rgba(255,255,255,.35)}
    .icon-btn{display:inline-flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:12px; border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06)}

    /* Banner superior */
    .banner{position:relative; height:52vh; min-height:360px; width:100%; overflow:hidden}
    .banner img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
    .banner .overlay{position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(11,18,32,1) 80%)}
    .banner .title{position:absolute; bottom:24px; left:50%; transform:translateX(-50%); width:min(1200px, 92vw); padding:0 20px}
    .title h1{margin:0; font-size:clamp(28px,4.5vw,48px)}
    .title p{margin:6px 0 0; color:var(--muted)}

    /* Tira por hora (full width) */
    .hour-strip{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border-top:1px solid rgba(255,255,255,.08); border-bottom:1px solid rgba(255,255,255,.08)}
    .hour-content{max-width:1200px; margin:0 auto; padding:14px 20px; display:grid; grid-template-columns: 120px 1fr; gap:16px; align-items:center}
    .hour-label{font-weight:800; color:#cfe3ff}
    .chips{display:flex; gap:8px; overflow:auto; padding-bottom:6px}
    .chip{display:flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:#0e1525; white-space:nowrap; font-weight:700; font-size:12px}
    .chip .bi{font-size:14px}

    /* Predicción + Mapa */
    .section{max-width:1200px; margin:18px auto; padding:0 20px}
    .grid{display:grid; grid-template-columns: 1fr 3fr; gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px}
    .card h3{margin:0 0 10px; font-size:16px; color:#cfe3ff}

    .forecast-list{display:grid; gap:10px}
    .day{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-radius:12px; background:#0e1525; border:1px solid rgba(255,255,255,.06)}
    .day strong{letter-spacing:.2px}
    .tag{font-size:12px; font-weight:800; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.16)}

    #map{height:360px; border-radius:12px}

    /* Alertas */
    .alerts{max-width:1200px; margin:18px auto; padding:0 20px}
    .alert-panel{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px}
    .alert-panel p{margin:8px 0; color:#cfe3ff}

    /* Botón Estadísticas */
    .center{display:flex; justify-content:center;}
    .btn-primary{display:inline-flex; align-items:center; gap:8px; padding:12px 18px; border-radius:14px; border:1px solid rgba(255,255,255,.18); background:linear-gradient(180deg, rgba(111,177,255,.35), rgba(111,177,255,.15)); font-weight:800; text-decoration:none}

    /* Modal usuario */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50}
    .modal .box{background:#0e1525; border:1px solid rgba(255,255,255,.12); border-radius:16px; width:min(480px,92vw); padding:16px}
    .modal h3{margin:0 0 12px}

    @media (max-width:980px){
      .hour-content{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      #map{height:300px}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="wrap">
      <div class="row">
        <div class="logo">TEMPO AIR</div>
        <nav>
          <a class="nav-btn" href="#explorar">Explorar mapa</a>
          <a class="nav-btn" href="#" id="btnLogin">Login</a>
          <a class="nav-btn" href="#" id="btnSignin">Sign In</a>
          <button class="icon-btn" id="btnUser" title="Usuario"><i class="bi bi-person"></i></button>
        </nav>
      </div>
    </div>
  </header>

  <!-- Banner -->
  <section class="banner">
    <img src="./Media/BannerImg.png" alt="Banner" />
    <div class="overlay"></div>
    <div class="title">
      <h1>TEMPO AIR</h1>
      <p>Desc lasdjflasjo odkjfkjdsokfjaksjdfkasjdflkjaskdfjsadlkjflasdjfldksjfljdaslfjlasdjflk dj fkljdslf jldkasj</p>
    </div>
  </section>

  <!-- Tira por hora (Regular / Good / Bad con iconos) -->
  <section class="hour-strip">
    <div class="hour-content">
      <div class="hour-label">Estadísticas</div>
      <div class="chips" id="hourChips">
        <!-- chips se llenan desde JS con (hora · estado · icono) -->
      </div>
    </div>
  </section>

  <!-- Predicción y Mapa -->
  <section class="section" id="explorar">
    <div class="grid">
      <div class="card">
        <h3>10-DAY FORECAST</h3>
        <div class="forecast-list" id="forecast"></div>
      </div>

      <div class="card">
        <h3>Mapa de contaminación – Saltillo</h3>
        <div id="map"></div>
      </div>
    </div>
  </section>

  <!-- Alertas -->
  <section class="alerts">
    <div class="alert-panel">
      <h3>ALERTAS</h3>
      <p><strong>El aire está limpio hoy.</strong></p>
      <p>Esto significa que los principales componentes del aire, como el oxígeno, dióxido de carbono y otras partículas, están en niveles normales.</p>
      <div id="alerts"></div>
    </div>
  </section>

  <!-- Botón Estadísticas (Power BI) -->
  <section class="section center">
    <a class="btn-primary" id="btnPowerBI" href="#" target="_blank" rel="noopener">
      <i class="bi bi-graph-up"></i>
      Estadísticas
    </a>
  </section>

  <!-- Modal Usuario -->
  <div class="modal" id="userModal">
    <div class="box">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <h3><i class="bi bi-person"></i> Perfil</h3>
        <button class="icon-btn" id="closeUserModal" title="Cerrar"><i class="bi bi-x"></i></button>
      </div>
      <p style="color:var(--muted)">Aquí aparecerán opciones de cuenta (iniciar sesión, cerrar sesión, ajustes). Integramos la autenticación cuando esté lista.</p>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="nav-btn" onclick="alert('Login próximamente');">Login</button>
        <button class="nav-btn" onclick="alert('Registro próximamente');">Sign In</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Estado ======
    let rows = [];
    let map, heat, markers = [];

    // ====== Utilidades ======
    function classifyScore(score){
      if(score < 35) return {label:'Good', color:'var(--good)', icon:'bi-heart-fill'};
      if(score > 65) return {label:'Bad', color:'var(--bad)', icon:'bi-exclamation-triangle-fill'};
      return {label:'Regular', color:'var(--regular)', icon:'bi-shield-check'};
    }
    function fmt(n,d=2){return (n==null||isNaN(n))?'—':Number(n).toFixed(d)}

    function scoreFrom(r){
      // mismo esquema simple del prototipo anterior
      const z = (
        (r.no2/100)*25 + (Math.max(0,r.o3)/120)*20 + (r.hcho/0.002)*15 + (r.so2/0.002)*15 + (r.co/2.0)*25
      )*100;
      return Math.max(0, Math.min(100, z));
    }

    function normalizeRow(row){
      const time = new Date(row.datetime || row.date_time || row.fecha || row.time);
      const lat = parseFloat(row.latitude ?? row.lat);
      const lon = parseFloat(row.longitude ?? row.lon ?? row.lng);
      const no2 = parseFloat(row.no2_value ?? row.no2);
      const o3  = parseFloat(row.o3_value ?? row.o3);
      const hcho= parseFloat(row.hcho_value ?? row.hcho);
      const so2 = parseFloat(row.so2_value ?? row.so2);
      const co  = parseFloat(row.co_value ?? row.co);
      return {time, lat, lon, no2, o3, hcho, so2, co};
    }

    // ====== Banner Hourly Line ======
    function renderHourStrip(){
      const cont = document.getElementById('hourChips');
      cont.innerHTML = '';
      // Tomamos 16 horas más recientes
      const last = rows.slice(-64); // 15min * 64 = 16h
      const byHour = new Map();
      for(const r of last){
        const k = r.time.toISOString().slice(0,13);
        const list = byHour.get(k) || []; list.push(scoreFrom(r)); byHour.set(k, list);
      }
      const items = Array.from(byHour.entries()).map(([k,vals])=>{
        const score = vals.reduce((a,b)=>a+b,0)/vals.length;
        const {label,color,icon} = classifyScore(score);
        const hour = new Date(k+':00:00Z');
        return {hour, label, color, icon, score:Math.round(score)}
      });
      for(const it of items){
        const div = document.createElement('div');
        div.className = 'chip';
        div.style.borderColor = `color-mix(in srgb, ${it.color} 40%, transparent)`;
        div.innerHTML = `<i class="bi ${it.icon}"></i> ${it.hour.toLocaleTimeString([], {hour:'2-digit'})} · ${it.label}`;
        cont.appendChild(div);
      }
    }

    // ====== Forecast (1/4 izquierda) ======
    function renderForecast(){
      const box = document.getElementById('forecast');
      box.innerHTML = '';
      // naive 10 días – reemplazar con applyForecast() cuando tengas el modelo
      const names=['Today','Mon','Tue','Wed','Thu','Fri','Sat','Sun','Mon+','Tue+'];
      const base = rows.length ? scoreFrom(rows[rows.length-1]) : 40;
      for(let i=0;i<10;i++){
        const s = Math.max(0, Math.min(100, base + (i-3)*2));
        const c = classifyScore(s);
        const line = document.createElement('div');
        line.className = 'day';
        line.innerHTML = `<strong>${names[i]||('Day '+(i+1))}</strong><span class="tag" style="border-color:${c.color}">${c.label} · ${Math.round(s)}</span>`;
        box.appendChild(line);
      }
    }

    // API pública para tu modelo
    window.applyForecast = function(pred){
      const box = document.getElementById('forecast');
      box.innerHTML = '';
      for(const d of pred){
        const c = classifyScore(d.score);
        const line = document.createElement('div');
        line.className='day';
        line.innerHTML = `<strong>${d.name}</strong><span class="tag" style="border-color:${c.color}">${d.label||c.label} · ${Math.round(d.score)}</span>`;
        box.appendChild(line);
      }
    }

    // ====== Mapa (3/4 derecha) ======
    function initMap(){
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 18, attribution:'&copy; OpenStreetMap'}).addTo(map);
      map.setView([25.438, -100.99], 12);
    }

    function renderPollution(){
      // limpia
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (heat){ map.removeLayer(heat); heat = null; }
      // Crea puntos ponderados por score
      const pts = rows.slice(-200).filter(r=>r.lat&&r.lon).map(r=>({lat:r.lat, lon:r.lon, s:scoreFrom(r)}));
      if(window.L && L.heatLayer && pts.length){
        const heatData = pts.map(p=>[p.lat, p.lon, Math.max(0.2, p.s/100)]);
        heat = L.heatLayer(heatData, {radius: 22, blur: 18, maxZoom: 12, minOpacity:.3}).addTo(map);
      } else {
        // fallback con círculos
        for(const p of pts){
          const c = classifyScore(p.s);
          const circle = L.circleMarker([p.lat,p.lon], {radius:6, weight:1, color:'#000', fillColor:getComputedStyle(document.documentElement).getPropertyValue(c.color) || '#fff', fillOpacity:.8});
          circle.addTo(map).bindTooltip(`${Math.round(p.s)} – ${c.label}`);
          markers.push(circle);
        }
      }
    }

    // ====== CSV ingest ======
    async function loadCSVFromInput(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file,{header:true,dynamicTyping:true,skipEmptyLines:true,complete:res=>resolve(res.data), error:reject});
      });
    }

    function ingest(data){
      rows = data.map(normalizeRow).filter(r=>r.time && !Number.isNaN(r.co)).sort((a,b)=>a.time-b.time);
      if(!rows.length){ alert('CSV sin filas válidas'); return; }
      renderHourStrip();
      renderForecast();
      renderPollution();
    }

    // ====== Interacciones ======
    // Arrastrar CSV a cualquier parte
    document.addEventListener('dragover', e=>e.preventDefault());
    document.addEventListener('drop', async (e)=>{
      e.preventDefault();
      const file = e.dataTransfer.files?.[0];
      if(!file) return;
      const data = await loadCSVFromInput(file);
      ingest(data);
    });

    // Modal usuario
    const userModal = document.getElementById('userModal');
    document.getElementById('btnUser').addEventListener('click', ()=>{ userModal.style.display='flex'; });
    document.getElementById('closeUserModal').addEventListener('click', ()=>{ userModal.style.display='none'; });
    userModal.addEventListener('click', (e)=>{ if(e.target===userModal) userModal.style.display='none'; });

    // Power BI – ajusta la URL real aquí
    document.getElementById('btnPowerBI').addEventListener('click', (e)=>{
      const url = 'https://app.powerbi.com/'; // TODO: reemplazar por tu enlace de reporte
      e.currentTarget.href = url;
    });

    // Boot
    window.addEventListener('DOMContentLoaded', ()=>{
      initMap();
      // Carga de muestra rápida (opcional):
      const sample = `datetime,date_only,zone,latitude,longitude,no2_value,o3_value,hcho_value,so2_value,co_value
`
        + `2025-10-04 06:00:00+00:00,2025-10-04,Centro,25.43932,-100.98761,48.70,-37.15,0.000248,0.000156,0.013653
`
        + `2025-10-04 06:15:00+00:00,2025-10-04,Centro,25.43695,-100.99498,44.15,-37.66,0.000112,0.000190,0.032190
`
        + `2025-10-04 06:30:00+00:00,2025-10-04,Centro,25.44460,-100.98054,44.04,-29.05,0.000010,0.000197,0.025429`;
      Papa.parse(sample,{header:true,dynamicTyping:true,complete:r=>ingest(r.data)});
    });
  </script>
</body>
</html>
